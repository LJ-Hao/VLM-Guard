<!DOCTYPE html>
<html>
<head>
    <title>Security Agent via VLM</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f7fa;
            min-height: 100vh;
            color: #333;
            overflow: hidden;
        }
        .container {
            width: 100%;
            height: 100vh;
            margin: 0;
            padding: 0;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: #ffffff;
            border-bottom: 1px solid #e0e0e0;
        }
        .main-title {
            margin: 0;
            color: #2c3e50;
            font-size: 2rem;
        }
        .status-info {
            text-align: right;
        }
        .status {
            font-weight: bold;
            font-size: 1rem;
        }
        .status.connected {
            color: #4caf50;
        }
        .status.disconnected {
            color: #f44336;
        }
        .last-updated {
            font-size: 0.9rem;
            color: #666;
            margin-top: 2px;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 15px;
            font-size: 1.8rem;
        }
        .info {
            margin: 10px 0;
            padding: 10px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            text-align: center;
            font-size: 0.9rem;
        }
        .content {
            display: flex;
            gap: 20px;
            height: calc(100vh - 100px);
            max-width: 100%;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .column {
            display: flex;
            flex-direction: column;
            gap: 20px;
            flex: 1;
        }
        
        .panel {
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            padding: 20px;
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 150px;
        }
        
        .video-panel {
            flex: 2;
        }
        
        .analysis-panel {
            flex: 1;
        }
        
        .chart-panel {
            flex: 1;
        }
        
        .chat-panel {
            flex: 2;
        }
        
        @media (max-width: 1200px) {
            .content {
                flex-direction: column;
                height: auto;
            }
            
            .column {
                gap: 15px;
            }
            
            .panel {
                min-width: 100%;
            }
        }
        
        .panel-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        @media (max-width: 1200px) {
            .content {
                flex-direction: column;
                height: auto;
            }
            
            .column {
                gap: 15px;
            }
            
            .panel {
                min-height: 150px;
            }
        }
        
        @media (max-width: 768px) {
            .content {
                gap: 15px;
            }
            
            .column {
                gap: 15px;
            }
            
            .panel {
                padding: 15px;
            }
            
            h2 {
                font-size: 1.3rem;
            }
            
            .chat-messages {
                padding: 15px;
            }
            
            .message {
                max-width: 90%;
                padding: 10px 14px;
            }
            
            .chat-input-wrapper {
                padding: 8px;
            }
            
            .chat-input-wrapper input {
                padding: 10px 12px;
                font-size: 0.9rem;
            }
            
            .chat-input-wrapper button {
                padding: 10px 16px;
                font-size: 0.9rem;
            }
        }
        
        .status {
            text-align: center;
            margin: 5px 0;
            font-weight: bold;
            font-size: 1rem;
        }
        
        .last-updated {
            font-size: 0.8rem;
            color: #666;
            text-align: center;
            margin: 2px 0 5px 0;
        }
        
        .lux-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #2c3e50;
            margin-top: 10px;
        }
        
        /* 滚动条样式 */
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-messages::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        @media (max-width: 1200px) {
            .panel {
                min-width: 100%;
            }
        }
        
        @media (max-width: 768px) {
            .content {
                gap: 15px;
            }
            
            .row {
                gap: 15px;
            }
            
            .panel {
                padding: 15px;
            }
            
            h2 {
                font-size: 1.3rem;
            }
            
            .chat-messages {
                padding: 15px;
            }
            
            .message {
                max-width: 90%;
                padding: 10px 14px;
            }
            
            .chat-input-wrapper {
                padding: 8px;
            }
            
            .chat-input-wrapper input {
                padding: 10px 12px;
                font-size: 0.9rem;
            }
            
            .chat-input-wrapper button {
                padding: 10px 16px;
                font-size: 0.9rem;
            }
        }
        .panel h2 {
            margin-top: 0;
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
            font-size: 1.4rem;
        }
        .panel h3 {
            margin-top: 15px;
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            padding-bottom: 6px;
            font-size: 1.1rem;
        }
        .video-container {
            flex: 3;
            display: flex;
            flex-direction: column;
            min-height: 150px;
        }
        
        .frame-container {
            flex: 2;
            display: flex;
            flex-direction: column;
            min-height: 150px;
        }
        
        .analysis-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 100px;
        }
        
        #latest-analysis {
            font-size: 1.1rem;
            line-height: 1.5;
            color: #000000; /* 黑色 */
        }
        
        #video-stream {
            width: 100%;
            max-width: 100%;
            height: auto;
            max-height: 100%;
            border: 1px solid #ddd;
            border-radius: 8px;
            object-fit: contain;
        }
        
        #analysis-frame {
            width: 100%;
            max-width: 100%;
            height: auto;
            max-height: 100%;
            border: 1px solid #ddd;
            border-radius: 8px;
            object-fit: contain;
        }
        
        #analysis-timestamp {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }
        
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.5;
            position: relative;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-message {
            align-self: flex-end;
            background-color: #4a9bff;
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .bot-message {
            align-self: flex-start;
            background-color: #ffffff;
            color: #333;
            border: 1px solid #e9ecef;
            border-bottom-left-radius: 4px;
        }
        
        .message-sender {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.85rem;
        }
        
        .user-message .message-sender {
            color: #ffffff;
            opacity: 0.9;
        }
        
        .bot-message .message-sender {
            color: #4a9bff;
        }
        
        .message-content {
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .chart-container {
            width: 100%;
            flex: 1;
            min-height: 200px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
            display: flex;
            justify-content: center;
            align-items: center;
            box-sizing: border-box;
        }
        
        .chat-input-container {
            display: flex;
            flex-direction: column;
        }
        
        .chat-input-wrapper {
            display: flex;
            gap: 10px;
            padding: 10px;
            background-color: #ffffff;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        
        .chat-input-wrapper input {
            flex: 1;
            padding: 12px 15px;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            outline: none;
        }
        
        .chat-input-wrapper button {
            background-color: #4a9bff;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        
        .chat-input-wrapper button:hover {
            background-color: #3a8beb;
        }
        
        .chat-input-wrapper button:active {
            transform: scale(0.98);
        }
        
        .danger-indicator {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 15px;
            font-weight: bold;
            margin-left: 10px;
            font-size: 0.9rem;
        }
        
        .danger-text {
            color: #f44336;
            font-weight: bold;
            font-size: 1.15rem;
        }
        
        .safe-text {
            color: #4caf50;
            font-weight: bold;
            font-size: 1.15rem;
        }
        
        .threat-text {
            color: #ffeb3b;
            font-weight: bold;
            font-size: 1.15rem;
        }
        
        .danger-indicator.danger {
            background-color: #f44336;
            color: white;
        }
        
        .danger-indicator.safe {
            background-color: #4caf50;
            color: white;
        }
        
        .danger-indicator.threat {
            background-color: #ffeb3b;
            color: black;
        }
        
        .countdown-timer {
            font-weight: bold;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="main-title">Security Agent via VLM</h1>
            <div class="status-info">
                <div class="status" id="main-status">
                    <span id="status-text">Connecting...</span>
                </div>
                <div class="last-updated" id="last-updated">Last updated: Never</div>
            </div>
        </div>
        
        <div class="content">
            <!-- 第一列：实时视频流和光照度传感器数据 -->
            <div class="column">
                <!-- 实时视频流 -->
                <div class="panel video-panel">
                    <h2>Live Video Stream</h2>
                    <div class="panel-content">
                        <div class="video-container">
                            <img id="video-stream" src="{{ url_for('video_feed') }}" alt="Video Stream">
                            <div class="status" id="video-status">
                                <p>Video Status: <span id="video-status-text">Connecting...</span></p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 光照度传感器数据 -->
                <div class="panel chart-panel">
                    <h2>Light Sensor(below 50 lux light turn red)</h2>
                    <div class="panel-content">
                        <div class="chart-container">
                            <canvas id="lux-chart" width="400" height="200" style="max-width: 100%; height: auto;"></canvas>
                            <div id="lux-placeholder" class="chart-placeholder">
                                No sensor data received yet.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 第二列：当前帧分析 -->
            <div class="column">
                <div class="panel analysis-panel">
                    <h2>Current Frame Analysis 
                        <span id="danger-indicator" class="danger-indicator" style="display: none;"></span>
                        <span id="countdown-timer" class="countdown-timer" style="float: right; font-size: 0.9rem; color: #666;"></span>
                    </h2>
                    <div class="panel-content">
                        <div class="frame-container">
                            <img id="analysis-frame" src="/analysis_frame_image" alt="Analysis Frame">
                        </div>
                        <div class="analysis-container">
                            <div id="latest-analysis" class="analysis-content">
                                No analysis received yet. Please start the video streamer.
                            </div>
                            <div id="analysis-timestamp" class="analysis-timestamp"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 第三列：聊天 -->
            <div class="column">
                <!-- 聊天 -->
                <div class="panel chat-panel">
                    <h2>Security Assistant Chat</h2>
                    <div class="panel-content">
                        <div class="chat-container">
                            <div id="chat-messages" class="chat-messages">
                                <div class="message bot-message">
                                    <div class="message-sender">Security Assistant</div>
                                    <div class="message-content">Hello! I'm the security assistant. You can ask me questions about the video analysis.</div>
                                </div>
                            </div>
                            <div class="chat-input-container">
                                <div class="chat-input-wrapper">
                                    <input type="text" id="chat-input" placeholder="Message Security Assistant..." />
                                    <button id="send-button">Send</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let lastUpdateTime = null;
        let refreshIntervalId = null;
        let resizeTimeout = null;
        let latestLuxData = null; // 存储最新的光照度数据
        let countdownIntervalId = null; // 倒计时定时器ID
        let lastAnalysisTime = null; // 上次分析时间
        let analysisInterval = 10; // 分析间隔（秒），默认10秒
        
        // 获取DOM元素
        const videoImg = document.getElementById('video-stream');
        const analysisFrameImg = document.getElementById('analysis-frame');
        const videoStatus = document.getElementById('video-status-text');
        const mainStatus = document.getElementById('status-text');
        const lastUpdated = document.getElementById('last-updated');
        const dangerIndicator = document.getElementById('danger-indicator');
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');
        const chatMessages = document.getElementById('chat-messages');
        const luxCanvas = document.getElementById('lux-chart');
        const luxPlaceholder = document.getElementById('lux-placeholder');
        
        // 更新最后更新时间显示
        function updateLastUpdated() {
            lastUpdateTime = new Date();
            lastUpdated.textContent = `Last updated: ${lastUpdateTime.toLocaleTimeString()}`;
        }
        
        // 更新倒计时显示
        function updateCountdown() {
            const countdownElement = document.getElementById('countdown-timer');
            if (!lastAnalysisTime) {
                countdownElement.textContent = '';
                return;
            }
            
            const now = new Date();
            const timeDiff = now.getTime() - lastAnalysisTime.getTime();
            const elapsedSeconds = Math.floor(timeDiff / 1000);
            const remainingSeconds = Math.max(0, analysisInterval - elapsedSeconds);
            
            if (remainingSeconds <= 0) {
                // 倒计时结束
                countdownElement.textContent = 'Analyzing...';
            } else {
                // 显示剩余秒数
                countdownElement.textContent = `${remainingSeconds}s`;
            }
        }
        
        // 启动倒计时（从分析间隔开始倒数）
        function startCountdownFromInterval() {
            // 重置倒计时为分析间隔时间
            let remainingSeconds = analysisInterval;
            const countdownElement = document.getElementById('countdown-timer');
            countdownElement.textContent = `${remainingSeconds}s`;
            
            // 如果已有倒计时定时器，先清除它
            if (countdownIntervalId) {
                clearInterval(countdownIntervalId);
            }
            
            // 启动新的倒计时
            countdownIntervalId = setInterval(function() {
                remainingSeconds--;
                if (remainingSeconds <= 0) {
                    // 倒计时结束，显示Analyzing...
                    countdownElement.textContent = 'Analyzing...';
                    clearInterval(countdownIntervalId);
                    countdownIntervalId = null;
                } else {
                    // 更新显示
                    countdownElement.textContent = `${remainingSeconds}s`;
                }
            }, 1000);
        }
        
        // 获取并更新光照度数据
        function loadLuxData() {
            fetch('/latest_lux_data')
                .then(response => response.json())
                .then(data => {
                    if (data.lux_data && data.lux_data.lux !== undefined) {
                        // 更新光照度显示
                        updateLuxDisplay(data.lux_data.lux);
                        // 保存最新数据
                        latestLuxData = data.lux_data;
                    } else {
                        // 显示占位符
                        luxPlaceholder.style.display = 'block';
                        // 隐藏画布
                        luxCanvas.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error loading lux data:', error);
                    // 显示占位符
                    luxPlaceholder.style.display = 'block';
                    // 隐藏画布
                    luxCanvas.style.display = 'none';
                });
        }
        
        // 绘制半扇形图（用于光照度数据）
        function drawLuxChart(canvas, lux) {
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            // 清除画布
            ctx.clearRect(0, 0, width, height);
            
            // 定义半扇形参数
            const centerX = width / 2;
            const centerY = height - 15; // 底部对齐
            const radius = Math.min(width, height) / 2 - 40; // 增加边距以容纳指针和标签
            
            // 将lux值映射到角度（0-1000 Lux映射到0-180度）
            const maxLux = 1000;
            const proportion = Math.min(lux / maxLux, 1);
            const angle = proportion * Math.PI; // 半圆（180度）
            
            // 确定颜色：低于50时为红色，否则为蓝色
            const chartColor = lux < 50 ? '#f44336' : '#4a9bff'; // 红色或蓝色
            const textColor = lux < 50 ? '#f44336' : '#4caf50'; // 红色或绿色
            
            // 绘制背景半圆（灰色）
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, Math.PI, 2 * Math.PI);
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 25;
            ctx.stroke();
            
            // 绘制数据半圆（根据lux值改变颜色）
            if (angle > 0) {
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, Math.PI, Math.PI + angle);
                ctx.strokeStyle = chartColor; // 根据lux值改变颜色
                ctx.lineWidth = 25;
                ctx.stroke();
            }
            
            // 绘制指针
            const pointerAngle = Math.PI + angle;
            const pointerLength = radius - 15;
            const pointerX = centerX + Math.cos(pointerAngle) * pointerLength;
            const pointerY = centerY + Math.sin(pointerAngle) * pointerLength;
            
            // 绘制指针线
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.lineTo(pointerX, pointerY);
            ctx.strokeStyle = '#2c3e50';
            ctx.lineWidth = 4;
            ctx.stroke();
            
            // 绘制指针头部
            ctx.beginPath();
            ctx.arc(pointerX, pointerY, 6, 0, 2 * Math.PI);
            ctx.fillStyle = '#2c3e50';
            ctx.fill();
            
            // 绘制中心圆点
            ctx.beginPath();
            ctx.arc(centerX, centerY, 10, 0, 2 * Math.PI);
            ctx.fillStyle = '#2c3e50';
            ctx.fill();
            
            // 在半扇形上方绘制lux值（根据lux值改变颜色）
            ctx.fillStyle = textColor; // 根据lux值改变颜色
            ctx.font = 'bold 18px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(`${lux} Lux`, centerX, centerY - radius - 20);
        }
        
        // 更新光照度数据显示
        function updateLuxDisplay(lux) {
            // 隐藏占位符
            luxPlaceholder.style.display = 'none';
            // 显示画布
            luxCanvas.style.display = 'block';
            
            // 绘制半扇形图
            drawLuxChart(luxCanvas, lux);
        }
        
        // 更新危险指示器
        function updateDangerIndicator(status) {
            const dangerIndicator = document.getElementById('danger-indicator');
            if (status === 'danger') {
                dangerIndicator.textContent = 'DANGER';
                dangerIndicator.className = 'danger-indicator danger';
                dangerIndicator.style.display = 'inline-block';
            } else if (status === 'threat') {
                dangerIndicator.textContent = 'THREAT';
                dangerIndicator.className = 'danger-indicator threat';
                dangerIndicator.style.display = 'inline-block';
            } else if (status === 'safe') {
                dangerIndicator.textContent = 'SAFE';
                dangerIndicator.className = 'danger-indicator safe';
                dangerIndicator.style.display = 'inline-block';
            } else {
                dangerIndicator.style.display = 'none';
            }
        }
        
        // 添加消息到聊天窗口
        function addMessageToChat(message, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
            
            const senderDiv = document.createElement('div');
            senderDiv.className = 'message-sender';
            senderDiv.textContent = isUser ? 'You' : 'Security Assistant';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = message;
            
            messageDiv.appendChild(senderDiv);
            messageDiv.appendChild(contentDiv);
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // 发送消息到数据库
        async function sendChatMessage() {
            const message = chatInput.value.trim();
            if (!message) return;
            
            // 添加用户消息到聊天窗口
            addMessageToChat(message, true);
            chatInput.value = '';
            
            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message: message })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    addMessageToChat(data.response);
                } else {
                    addMessageToChat('Error: Failed to get response from database');
                }
            } catch (error) {
                addMessageToChat('Error: ' + error.message);
            }
        }
        
        // 检查视频图像是否加载成功
        videoImg.onload = function() {
            videoStatus.textContent = 'Connected';
            videoStatus.style.color = '#4caf50';
            mainStatus.textContent = 'Connected';
            mainStatus.className = 'status connected';
        };
        
        videoImg.onerror = function() {
            videoStatus.textContent = 'Disconnected';
            videoStatus.style.color = '#f44336';
            mainStatus.textContent = 'Video Disconnected';
            mainStatus.className = 'status disconnected';
        };
        
        // 获取最新分析结果并更新页面
        function loadLatestAnalysis() {
            // 首先获取光照度数据，然后获取分析数据
            Promise.all([
                fetch('/latest_lux_data').then(response => response.json()),
                fetch('/latest_description').then(response => response.json())
            ])
            .then(([luxData, analysisData]) => {
                console.log('Received analysis data:', analysisData);
                const analysisDiv = document.getElementById('latest-analysis');
                const timestampDiv = document.getElementById('analysis-timestamp');
                
                // 移除之前的状态类
                analysisDiv.classList.remove('danger-text', 'safe-text');
                
                // 检查光照度是否低于50
                let isLuxDangerous = false;
                if (luxData.lux_data && luxData.lux_data.lux !== undefined) {
                    isLuxDangerous = luxData.lux_data.lux < 50;
                }
                
                if (analysisData.description && analysisData.description.text) {
                    // 解析返回的数据（可能是字符串或对象）
                    let parsedAnalysisData;
                    if (typeof analysisData.description.text === 'string') {
                        try {
                            parsedAnalysisData = JSON.parse(analysisData.description.text);
                        } catch (e) {
                            // 如果不是JSON格式，构造一个对象
                            parsedAnalysisData = {
                                description: analysisData.description.text,
                                danger: null,
                                date: analysisData.description.timestamp
                            };
                        }
                    } else {
                        parsedAnalysisData = analysisData.description.text;
                    }
                    
                    // 如果有分析时间戳，启动倒计时（只在真正收到新分析结果时）
                    if (parsedAnalysisData.date) {
                        // 检查是否是新的分析结果（与上次不同）
                        const currentTime = new Date(parsedAnalysisData.date).getTime();
                        const lastTime = lastAnalysisTime ? lastAnalysisTime.getTime() : 0;
                        
                        if (currentTime > lastTime) {
                            // 更新最后分析时间
                            lastAnalysisTime = new Date(parsedAnalysisData.date);
                            // 启动倒计时
                            startCountdownFromInterval();
                        }
                    }
                    
                    // 如果光照度低于50，覆盖VLM的分析结果
                    let finalDanger = parsedAnalysisData.danger;
                    let finalDescription = parsedAnalysisData.description || 'No description available';
                    let displayStatus = null;
                    
                    if (isLuxDangerous) {
                        // 光照度危险（红色）
                        finalDanger = true;
                        displayStatus = 'danger';
                        finalDescription = 'DANGER: Low light conditions detected (below 50 lux). ' + finalDescription;
                    } else if (parsedAnalysisData.danger === true) {
                        // VLM检测到威胁（黄色）
                        displayStatus = 'threat';
                    } else if (parsedAnalysisData.danger === false) {
                        // 安全状态（绿色）
                        displayStatus = 'safe';
                    }
                    
                    // 显示描述信息
                    analysisDiv.textContent = finalDescription;
                    
                    // 根据危险性更新样式（光照度优先级更高）
                    if (isLuxDangerous) {
                        analysisDiv.classList.add('danger-text');
                    } else if (parsedAnalysisData.danger === true) {
                        // VLM检测到威胁，使用黄色文本
                        analysisDiv.classList.add('threat-text');
                    } else if (parsedAnalysisData.danger === false) {
                        analysisDiv.classList.add('safe-text');
                    }
                    
                    // 更新危险指示器（光照度优先级更高）
                    updateDangerIndicator(displayStatus);
                    
                    // 显示时间戳
                    const timestamp = parsedAnalysisData.date || analysisData.description.timestamp;
                    timestampDiv.textContent = timestamp ? 
                        `Analyzed at: ${timestamp}` : '';
                    
                    // 更新状态
                    mainStatus.textContent = 'Connected';
                    mainStatus.className = 'status connected';
                } else {
                    // 即使没有分析数据，如果光照度低于50，也要显示危险状态
                    let displayStatus = null;
                    if (isLuxDangerous) {
                        analysisDiv.textContent = 'DANGER: Low light conditions detected (below 50 lux).';
                        analysisDiv.classList.add('danger-text');
                        displayStatus = 'danger';
                    } else {
                        analysisDiv.textContent = 'No analysis received yet. Please start the video streamer.';
                        analysisDiv.classList.remove('danger-text', 'safe-text');
                        displayStatus = null;
                    }
                    updateDangerIndicator(displayStatus);
                    timestampDiv.textContent = '';
                    
                    // 更新状态
                    mainStatus.textContent = 'Connected';
                    mainStatus.className = 'status connected';
                }
                
                updateLastUpdated();
                
                // 更新分析帧图像
                analysisFrameImg.src = '/analysis_frame_image?' + new Date().getTime();
            })
            .catch(error => {
                console.error('Error loading latest analysis:', error);
                
                // 更新状态
                mainStatus.textContent = 'Analysis Disconnected';
                mainStatus.className = 'status disconnected';
            });
        }
        
        // 加载所有分析相关数据
        function loadAllAnalysisData() {
            loadLatestAnalysis();
            loadLuxData(); // 加载光照度数据
        }
        
        // 处理窗口大小调整
        function handleResize() {
            // 清除之前的超时
            if (resizeTimeout) {
                clearTimeout(resizeTimeout);
            }
            
            // 设置新的超时
            resizeTimeout = setTimeout(function() {
                // 重新加载数据以适应新的窗口大小
                loadAllAnalysisData();
            }, 300);
        }
        
        // 页面加载完成后开始加载数据
        document.addEventListener('DOMContentLoaded', function() {
            // 初始加载数据
            loadAllAnalysisData();
            
            // 启动自动刷新（每2秒）
            refreshIntervalId = setInterval(loadAllAnalysisData, 2000);
            
            // 启动初始倒计时
            startCountdownFromInterval();
            
            // 监听聊天发送按钮
            sendButton.addEventListener('click', sendChatMessage);
            
            // 监听回车键发送消息
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendChatMessage();
                }
            });
            
            // 定期检查视频连接状态
            setInterval(function() {
                // 通过重新设置src来触发重新加载
                videoImg.src = videoImg.src.split('?')[0] + '?' + new Date().getTime();
            }, 30000); // 每30秒检查一次
            
            // 监听窗口大小调整
            window.addEventListener('resize', handleResize);
        });
    </script>
</body>
</html>